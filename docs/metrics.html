<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Build Size Trend</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 24px;
      }
      canvas {
        max-width: 1100px;
        width: 100%;
        height: 420px;
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
      }
      .legend {
        margin: 8px 0 24px;
        color: #444;
      }
      .legend code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 4px;
      }
    </style>
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
      integrity="sha256-5Jhxg1xw6mIiMHPT+qWYL90iVOwLLwlm8+I2w3m1ZrU="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div class="wrap">
      <h1>Build artifact size trend</h1>
      <p class="legend">
        Source: <code>docs/sizes.csv</code> (updated by CI). Values in MB.
      </p>
      <canvas id="chart"></canvas>
    </div>
    <script>
      async function loadCSV(url) {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load CSV");
        const text = await res.text();
        const lines = text.trim().split(/\r?\n/);
        const headers = lines.shift().split(",");
        const idx = Object.fromEntries(headers.map((h, i) => [h, i]));
        const rows = lines.map((line) => line.split(","));
        return rows.map((r) => ({
          ts: new Date(r[idx.timestamp]),
          sha: r[idx.sha],
          bin: +r[idx.bin_bytes],
          wasm: +r[idx.wasm_bytes],
          js: +r[idx.js_bytes],
          css: +r[idx.css_bytes],
        }));
      }
      function toMB(bytes) {
        return bytes / (1024 * 1024);
      }
      (async function () {
        try {
          const data = await loadCSV("sizes.csv");
          // Sort by timestamp ascending
          data.sort((a, b) => a.ts - b.ts);
          const labels = data.map((d) =>
            d.ts.toISOString().slice(0, 19).replace("T", " ")
          );
          const cfg = {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Binary (MB)",
                  data: data.map((d) => toMB(d.bin)),
                  borderColor: "#2563eb",
                  backgroundColor: "rgba(37,99,235,0.15)",
                  tension: 0.2,
                },
                {
                  label: "WASM (MB)",
                  data: data.map((d) => toMB(d.wasm)),
                  borderColor: "#16a34a",
                  backgroundColor: "rgba(22,163,74,0.15)",
                  tension: 0.2,
                },
                {
                  label: "JS (MB)",
                  data: data.map((d) => toMB(d.js)),
                  borderColor: "#f59e0b",
                  backgroundColor: "rgba(245,158,11,0.15)",
                  tension: 0.2,
                },
                {
                  label: "CSS (MB)",
                  data: data.map((d) => toMB(d.css)),
                  borderColor: "#ef4444",
                  backgroundColor: "rgba(239,68,68,0.15)",
                  tension: 0.2,
                },
              ],
            },
            options: {
              responsive: true,
              interaction: { mode: "nearest", axis: "x", intersect: false },
              plugins: {
                legend: { position: "bottom" },
                tooltip: {
                  callbacks: {
                    title: (items) => {
                      const i = items[0].dataIndex;
                      return `Commit ${data[i].sha.slice(0, 7)} @ ${labels[i]}`;
                    },
                    label: (c) => `${c.dataset.label}: ${c.formattedValue} MB`,
                  },
                },
              },
              scales: {
                y: { title: { display: true, text: "Size (MB)" } },
                x: { title: { display: true, text: "Time" } },
              },
            },
          };
          new Chart(document.getElementById("chart"), cfg);
        } catch (e) {
          console.error(e);
          document.body.insertAdjacentHTML(
            "beforeend",
            "<p>Failed to load sizes.csv</p>"
          );
        }
      })();
    </script>
  </body>
</html>
