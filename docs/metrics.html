<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Build Size Trend</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 24px;
      }
      canvas {
        max-width: 1100px;
        width: 100%;
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
      }
      .legend {
        margin: 8px 0 24px;
        color: #444;
      }
      .legend code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 4px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div class="wrap">
      <h1>Build artifact size trend</h1>
      <p class="legend">
        Source: <code>sizes.csv</code> (updated by CI). Values in MB.
        <a href="sizes.csv" target="_blank" rel="noopener">open CSV</a>
      </p>
      <canvas id="chart"></canvas>
    </div>
    <script>
      async function loadCSV(url) {
        const v = Date.now();
        const sep = url.indexOf("?") >= 0 ? "&" : "?";
        const res = await fetch(url + sep + "v=" + v, { cache: "no-store" });
        if (!res.ok)
          throw new Error(
            "Failed to load CSV (" +
              res.status +
              " " +
              res.statusText +
              ") @ " +
              url
          );
        const text = await res.text();
        const lines = text
          .trim()
          .split(/\r?\n/)
          .filter((l) => l.length);
        if (!lines.length) return [];
        const headers = lines.shift().split(",");
        const idx = Object.fromEntries(headers.map((h, i) => [h, i]));
        const rows = lines.map((line) => line.split(","));
        return rows.map((r) => ({
          ts: new Date(r[idx.timestamp]),
          sha: r[idx.sha],
          bin: Number(r[idx.bin_bytes] || 0),
          wasm: Number(r[idx.wasm_bytes] || 0),
          js: Number(r[idx.js_bytes] || 0),
          css: Number(r[idx.css_bytes] || 0),
        }));
      }
      function toMB(bytes) {
        return bytes / (1024 * 1024);
      }
      (async function () {
        try {
          const data = await loadCSV("sizes.csv");
          data.sort((a, b) => a.ts - b.ts);
          const labels = data.map((d) =>
            d.ts.toISOString().slice(0, 19).replace("T", " ")
          );
          const cfg = {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Binary (MB)",
                  data: data.map((d) => toMB(d.bin)),
                  borderColor: "#2563eb",
                  backgroundColor: "rgba(37,99,235,0.15)",
                  tension: 0.2,
                },
                {
                  label: "WASM (MB)",
                  data: data.map((d) => toMB(d.wasm)),
                  borderColor: "#16a34a",
                  backgroundColor: "rgba(22,163,74,0.15)",
                  tension: 0.2,
                },
                {
                  label: "JS (MB)",
                  data: data.map((d) => toMB(d.js)),
                  borderColor: "#f59e0b",
                  backgroundColor: "rgba(245,158,11,0.15)",
                  tension: 0.2,
                },
                {
                  label: "CSS (MB)",
                  data: data.map((d) => toMB(d.css)),
                  borderColor: "#ef4444",
                  backgroundColor: "rgba(239,68,68,0.15)",
                  tension: 0.2,
                },
              ],
            },
            options: {
              responsive: true,
              interaction: { mode: "nearest", axis: "x", intersect: false },
              plugins: {
                legend: { position: "bottom" },
                tooltip: {
                  callbacks: {
                    title: (items) => {
                      const i = items[0].dataIndex;
                      return (
                        "Commit " + data[i].sha.slice(0, 7) + " @ " + labels[i]
                      );
                    },
                    label: (c) =>
                      c.dataset.label + ": " + c.formattedValue + " MB",
                  },
                },
              },
              scales: {
                y: { title: { display: true, text: "Size (MB)" } },
                x: { title: { display: true, text: "Time" } },
              },
            },
          };
          new Chart(document.getElementById("chart"), cfg);
        } catch (e) {
          console.error(e);
          var msg = e && e.message ? e.message : "Failed to load sizes.csv";
          document.body.insertAdjacentHTML("beforeend", "<p>" + msg + "</p>");
        }
      })();
    </script>
  </body>
</html>
